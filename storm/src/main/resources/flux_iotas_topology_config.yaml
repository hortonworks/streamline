name: "iotas-topology"
config:
#  topology.debug: true
  catalog.root.url: ${catalog.root.url}
  local.parser.jar.path: ${parser.jar.path}
  hbase.conf:
    hbase.root.dir: ${hbase.root.dir}

components:
  - id: "zkHosts"
    className: "storm.kafka.ZkHosts"
    constructorArgs:
      - ${kafka.spout.zkUrl}

  - id: "spoutConfig"
    className: "storm.kafka.SpoutConfig"
    constructorArgs:
      - ref: "zkHosts"
      - ${kafka.spout.topic}
      - ${kafka.spout.zkRoot}
      - ${kafka.spout.id}

  - id: "hBaseMapper"
    className: "com.hortonworks.hbase.ParserOutputHBaseMapper"
    constructorArgs:
      - ${hbase.column.family}

  - id: "recordFormat"
    className: "com.hortonworks.hdfs.IdentityHdfsRecordFormat"

  - id: "syncPolicy"
    className: "org.apache.storm.hdfs.bolt.sync.CountSyncPolicy"
    constructorArgs:
      - ${hdfs.syncPolicyCount}

  - id: "rotationPolicy"
    className: "org.apache.storm.hdfs.bolt.rotation.TimedRotationPolicy"
    constructorArgs:
      - ${hdfs.rotationInterval}
      - SECONDS

  - id: "fileNameFormat"
    className: "org.apache.storm.hdfs.bolt.format.DefaultFileNameFormat"
    configMethods:
      - name: "withPath"
        args:
          - ${hdfs.path}
      - name: "withPrefix"
        args:
          - ${hdfs.name}

# spout definitions
spouts:
  - id: "KafkaSpout"
    className: "storm.kafka.KafkaSpout"
    constructorArgs:
      - ref: "spoutConfig"

# bolt definitions
bolts:
  - id: "ParserBolt"
    className: "com.hortonworks.bolt.ParserBolt"
    configMethods:
      - name: "withParsedTuplesStreamId"
        args:
          - "good"
      - name: "withUnparsedTuplesStreamId"
        args:
          - "bad"

  - id: "PrinterBolt"
    className: "com.hortonworks.bolt.PrinterBolt"

  - id: "HBaseBolt"
    className: "org.apache.storm.hbase.bolt.HBaseBolt"
    constructorArgs:
      - ${hbase.table}
      - ref: "hBaseMapper"
    configMethods:
      - name: "withConfigKey"
        args:
          - "hbase.conf"

  - id: "HdfsBolt"
    className: "org.apache.storm.hdfs.bolt.HdfsBolt"
    configMethods:
      - name: "withFsUrl"
        args:
          - ${hdfs.fsUrl}
      - name: "withFileNameFormat"
        args:
          - ref: "fileNameFormat"
      - name: "withRecordFormat"
        args:
          - ref: "recordFormat"
      - name: "withRotationPolicy"
        args:
          - ref: "rotationPolicy"
      - name: "withSyncPolicy"
        args:
          - ref: "syncPolicy"

#stream definitions
streams:
  - name: "kafka --> parser"
    from: "KafkaSpout"
    to: "ParserBolt"
    grouping:
      type: SHUFFLE

  - name: "paser --> printer"
    from: "ParserBolt"
    to: "PrinterBolt"
    grouping:
      type: SHUFFLE
      streamId: "good"

  - name: "paser --> hbase"
    from: "ParserBolt"
    to: "HBaseBolt"
    grouping:
      type: SHUFFLE
      streamId: "good"

  - name: "paser --> hdfs"
    from: "ParserBolt"
    to: "HdfsBolt"
    grouping:
      type: SHUFFLE
      streamId: "bad"

